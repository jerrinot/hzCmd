#!/usr/bin/env bash

count=${1:-0}
instanceType=${2:-c4.xlarge}
outputFile=${3:-a.box}

imageId=${4:-ami-08111162}
region=${5:-us-east-1}

key=${6:-jenkins-ec2-key}
subnetId=${7:-subnet-378d2140}
placement=${8:-hzpc2}


if [ -f "${outputFile}" ]; then

 currentBoxCount=$(cat ${outputFile} 2>/dev/null | wc -l)
 count=$(( ${count} - ${currentBoxCount} ))

fi

echo "creating ${count} aws instances"

tryCount=0
while (( ${count} > 0 )) ; do

 aws-getBox ${count} ${imageId} ${region} ${instanceType} ${key} ${subnetId} ${placement} ${outputFile}
 sleep 30
 aws-Terminate-brokenBox ${outputFile}
 count=$?

 if (( tryCount++ > 2 )) ; then
   aws-terminate ${outputFile}
   exit 1;
 fi

done
